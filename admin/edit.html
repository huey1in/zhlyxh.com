<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑回忆 - 后台管理</title>
    <style>
        :root {
            --bg-body: #f7f9fc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --primary: #f43f5e;
            --primary-hover: #e11d48;
            --danger: #ef4444;
            --success: #10b981;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --radius: 8px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 700px; margin: 0 auto; }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        h1 { 
            font-size: 1.5rem; 
            font-weight: 600; 
            margin: 0;
            color: var(--text-main); 
            letter-spacing: -0.5px; 
        }
        
        .back-link {
            color: var(--text-sub);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .back-link:hover { color: var(--primary); }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 32px;
            box-shadow: var(--shadow-sm);
        }

        .form-group { margin-bottom: 24px; }
        .form-group:last-child { margin-bottom: 0; }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label { 
            display: block; 
            margin-bottom: 8px; 
            font-size: 0.875rem; 
            font-weight: 600; 
            color: var(--text-main); 
        }
        
        .label-hint {
            font-weight: 400;
            color: var(--text-sub);
            margin-left: 8px;
        }

        input, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            background: #fff;
            color: var(--text-main);
            outline: none;
            font-family: inherit;
            transition: all 0.2s;
        }
        input:focus, textarea:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.15); 
        }
        textarea { 
            resize: vertical; 
            min-height: 120px; 
            line-height: 1.6;
        }

        /* 双视角区域 */
        .views-section {
            background: #f8fafc;
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }
        .views-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .view-input-group { margin-bottom: 16px; }
        .view-input-group:last-child { margin-bottom: 0; }
        .view-input-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .view-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            color: #fff;
            background: var(--primary);
            padding: 3px 10px;
            border-radius: 12px;
        }
        .view-badge.yxh { background: #6b9fff; }

        /* 图片上传区域 */
        .images-section {
            background: #f8fafc;
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(244, 63, 94, 0.02);
        }
        .upload-area input[type="file"] { display: none; }
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: var(--text-sub);
        }
        .upload-text { color: var(--text-sub); font-size: 0.9rem; }
        .upload-text strong { color: var(--primary); }
        .upload-hint { color: var(--text-sub); font-size: 0.8rem; margin-top: 8px; }

        .images-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: #fff;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-preview-item .remove-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .image-preview-item:hover .remove-btn { opacity: 1; }
        .image-preview-item .remove-btn:hover { background: var(--danger); }

        /* 按钮 */
        .actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 28px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { 
            background: #cbd5e1; 
            cursor: not-allowed; 
            transform: none;
        }

        button.secondary { 
            background: #fff; 
            color: var(--text-sub); 
            border: 1px solid var(--border); 
        }
        button.secondary:hover { 
            background: #f1f5f9; 
            color: var(--text-main); 
        }

        /* Toast 通知 */
        #toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .toast {
            background: #fff;
            padding: 14px 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            min-width: 300px;
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .toast.show { transform: translateX(0); }
        .toast-icon { margin-right: 14px; display: flex; align-items: center; }
        .toast-message { font-size: 0.9rem; color: #334155; font-weight: 500; }

        /* 加载状态 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-sub);
        }

        @media (max-width: 600px) {
            body { padding: 20px 16px; }
            .card { padding: 24px 20px; }
            .form-row { grid-template-columns: 1fr; gap: 16px; }
            .actions { flex-direction: column; }
            .actions button { width: 100%; }
            #toast-container { right: 16px; left: 16px; }
            .toast { min-width: auto; }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div class="container">
        <div class="header">
            <h1 id="pageTitle">新增回忆</h1>
            <a href="/admin" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                返回列表
            </a>
        </div>

        <div class="card" id="formCard">
            <div class="loading" id="loading" style="display: none;">
                加载中...
            </div>
            
            <form id="editForm">
                <input type="hidden" id="itemId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">日期</label>
                        <input id="date" type="text" placeholder="2025.05.20" required>
                    </div>
                    <div class="form-group">
                        <label for="title">标题</label>
                        <input id="title" type="text" placeholder="例如: 第一次旅行" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="views-section">
                        <div class="views-section-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            双视角描述
                        </div>
                        <div class="view-input-group">
                            <label>
                                <span class="view-badge">ZHL</span>
                                的视角
                            </label>
                            <textarea id="viewZhl" rows="4" placeholder="从ZHL的角度写下那天的故事..."></textarea>
                        </div>
                        <div class="view-input-group">
                            <label>
                                <span class="view-badge yxh">YXH</span>
                                的视角
                            </label>
                            <textarea id="viewYxh" rows="4" placeholder="从YXH的角度写下那天的故事..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="images-section">
                        <div class="views-section-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            照片 <span class="label-hint">（最多9张，支持九宫格布局）</span>
                        </div>
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="imageFiles" accept="image/*" multiple>
                            <div class="upload-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <div class="upload-text">点击或拖拽上传照片</div>
                            <div class="upload-hint">支持 JPG、PNG、GIF 格式</div>
                        </div>
                        <div class="images-preview" id="imagesPreview"></div>
                    </div>
                </div>

                <div class="actions">
                    <button type="button" class="secondary" onclick="window.location.href='/admin'">取消</button>
                    <button type="submit" id="submitBtn">保存回忆</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // DOM 元素
        const pageTitle = document.getElementById('pageTitle');
        const editForm = document.getElementById('editForm');
        const itemIdInput = document.getElementById('itemId');
        const dateInput = document.getElementById('date');
        const titleInput = document.getElementById('title');
        const viewZhlInput = document.getElementById('viewZhl');
        const viewYxhInput = document.getElementById('viewYxh');
        const imageFilesInput = document.getElementById('imageFiles');
        const imagesPreview = document.getElementById('imagesPreview');
        const uploadArea = document.getElementById('uploadArea');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');

        let currentImages = [];

        // Toast 图标
        const toastIcons = {
            success: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
            error: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`,
            info: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`
        };

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <span class="toast-icon">${toastIcons[type]}</span>
                <span class="toast-message">${message}</span>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        // 获取 URL 参数
        function getUrlParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // 渲染图片预览
        function renderImagesPreview() {
            imagesPreview.innerHTML = '';
            currentImages.forEach((imgUrl, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                item.innerHTML = `
                    <img src="${imgUrl}" alt="预览">
                    <button type="button" class="remove-btn" data-index="${index}">×</button>
                `;
                imagesPreview.appendChild(item);
            });
        }

        // 图片删除事件
        imagesPreview.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                const index = parseInt(e.target.dataset.index);
                currentImages.splice(index, 1);
                renderImagesPreview();
            }
        });

        // 上传区域点击
        uploadArea.addEventListener('click', () => imageFilesInput.click());

        // 拖拽上传
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary)';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '';
        });
        uploadArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '';
            const files = e.dataTransfer.files;
            await handleFiles(files);
        });

        // 文件选择
        imageFilesInput.addEventListener('change', async () => {
            await handleFiles(imageFilesInput.files);
            imageFilesInput.value = '';
        });

        // 处理文件上传
        async function handleFiles(files) {
            if (!files.length) return;

            const remaining = 9 - currentImages.length;
            if (remaining <= 0) {
                showToast('最多只能上传9张照片', 'info');
                return;
            }

            const filesToUpload = Array.from(files).slice(0, remaining);
            if (files.length > remaining) {
                showToast(`已选择${files.length}张，仅上传前${remaining}张`, 'info');
            }

            for (const file of filesToUpload) {
                try {
                    const dataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    const uploadRes = await fetch('/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: file.name, dataUrl }),
                    });
                    if (!uploadRes.ok) throw new Error('upload failed');
                    const uploaded = await uploadRes.json();
                    currentImages.push(uploaded.url);
                } catch (e) {
                    showToast('图片上传失败: ' + file.name, 'error');
                }
            }
            renderImagesPreview();
        }

        // 加载编辑数据
        async function loadItemData(id) {
            loading.style.display = 'flex';
            editForm.style.display = 'none';
            
            try {
                const res = await fetch(`/api/items?_t=${Date.now()}`, { cache: 'no-store' });
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                const item = (data.items || []).find(i => i.id === id);
                
                if (item) {
                    itemIdInput.value = id;
                    dateInput.value = item.date || '';
                    titleInput.value = item.title || '';
                    viewZhlInput.value = item.views?.zhl || item.desc || '';
                    viewYxhInput.value = item.views?.yxh || '';
                    currentImages = item.images || (item.image ? [item.image] : []);
                    renderImagesPreview();
                    pageTitle.textContent = '编辑回忆';
                } else {
                    showToast('未找到该条目', 'error');
                    setTimeout(() => window.location.href = '/admin', 1500);
                }
            } catch (e) {
                showToast('加载数据失败', 'error');
            } finally {
                loading.style.display = 'none';
                editForm.style.display = 'block';
            }
        }

        // 表单提交
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!dateInput.value || !titleInput.value) {
                showToast('请填写日期和标题', 'info');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '保存中...';

            const payload = {
                date: dateInput.value,
                title: titleInput.value,
                images: currentImages,
                views: {
                    zhl: viewZhlInput.value,
                    yxh: viewYxhInput.value
                }
            };

            const id = itemIdInput.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/items/${id}` : '/api/items';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                
                if (res.ok) {
                    showToast(id ? '回忆已更新' : '新回忆已添加', 'success');
                    setTimeout(() => window.location.href = '/admin', 1000);
                } else {
                    throw new Error('保存失败');
                }
            } catch (e) {
                showToast('保存失败，请重试', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '保存回忆';
            }
        });

        // 初始化
        const editId = getUrlParam('id');
        if (editId) {
            loadItemData(editId);
        }
    </script>
</body>
</html>
